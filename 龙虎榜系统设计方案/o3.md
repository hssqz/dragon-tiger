# 龙虎榜系统设计方案

## 一、总体架构

### 1. 数据层（Data Layer）
- **原始文件区**：每日四张 CSV (`hm_list_data.csv`, `hm_stock_details_YYYYMMDD.csv`, `top_list.csv`, `top_data.csv`) 原样保存，按日期归档。
- **ETL 清洗区**：使用 Pandas / Polars 进行字段标准化、数字字段格式化、异常值校验。
- **存储区**  
  - **MVP**：SQLite（轻量、零运维）  
  - **Pro**：PostgreSQL + Timescale（时序优化）
- **表设计**  
  | 表名 | 说明 | 数据来源 |
  | ---- | ---- | -------- |
  | `trader_profile` | 游资档案 | hm_list_data |
  | `trader_trade_daily` | 游资-股票-金额明细 | hm_stock_details |
  | `top_stock_summary` | 股票层面榜单 | top_list |
  | `top_stock_detail`  | 股票-席位明细 | top_data |

### 2. 服务层（Service Layer）
- **指标计算服务**：Python + FastAPI，生成游资 / 股票 / 席位 / 行业各类指标与排名。
- **策略与告警服务**：事件驱动，当满足阈值触发 Webhook／短信／钉钉机器人。
- **AI 解释服务（可选）**：调用 OpenAI API，总结游资动向，自动生成自然语言点评。

### 3. 展示层（Presentation Layer）
- **MVP**：Streamlit Dashboard（最快成型）。
- **后续**：Vue3 + ECharts + FastAPI (Rest / GraphQL)。

---

## 二、核心功能拆解

### 0. 数据接入与质检
0.1 自动拉取四张表 → ETL → DB  
0.2 字段校验、缺失值提示、异常金额报警

### 1. 游资画像模块
1. 基础档案：简介、惯用营业部、风格关键词  
2. 资金规模估算：近 30/60/120 日买入 & 卖出总额  
3. 胜率 & 平均持股日：结合后续行情数据  
4. 一键对比：多游资雷达图

### 2. 个股龙虎榜解析
1. 单股席位榜：买一-买五、卖一-卖五金额/占比  
2. 概览指标：净买额、换手贡献、买卖集中度、游资 vs 机构 vs 北向  
3. 历史对照：近 N 日上榜记录 + 涨跌幅曲线  
4. AI 点评（可选）

### 3. 游资-个股关系网络（Graph）
- 节点：游资、股票  
- 边：买入/卖出金额（权重可调）  
- 应用示例：  
  • 同行联动雷达 —— 发现多游资同天扫同一票  
  • 热门股跟踪 —— 最近 3 日被最多顶级游资买入的股票

### 4. 主题/题材热度追踪
1. 股票 ↔ 题材映射（第三方或手工）  
2. 统计题材内净买额、上榜次数、领涨票  
3. 输出《题材龙虎热度榜》

### 5. 高级指标 & 信号引擎（Pro）
- **锁仓强度**：连续多日净买且当日卖出≤20%  
- **游资抱团度**：同股前五席位中游资席位占比  
- **跳槽信号**：核心游资短期频繁换票  
- **策略 DSL**：勾选条件 → 返回候选股/游资d

### 6. 实时预警 & 推送
- 条件：大额净买、机构/北向大额卖出、抱团度升高…  
- 渠道：邮件 / 钉钉 / 飞书 / 微信小程序

---

## 三、实施里程碑
| 阶段 | 周期 | 交付 | 说明 |
| ---- | ---- | ---- | ---- |
| Sprint-1 | 1-2 周 | ETL + SQLite + Streamlit MVP | 游资档案 / 个股榜单 / 简单指标 |
| Sprint-2 | 3-4 周 | Graph 关系图、题材热度榜、简易告警 | |
| Sprint-3 | 5-6 周 | 策略 DSL、AI 点评、推送渠道 | |
| Sprint-4 | 持续 | PG + Timescale、量化评估、SaaS 多租户 | |

---

## 四、技术选型
- 数据处理：Python 3.11 + Pandas / Polars + SQLModel  
- API：FastAPI（异步高性能）  
- 前端：Streamlit（MVP）→ Vue3 + NaïveUI/ECharts  
- 调度：APScheduler / Airflow  
- 部署：Docker Compose → K8s + CI/CD

---

## 五、最小可行闭环（MVP）
1. 每日 07:00 定时脚本：CSV → DB  
2. Streamlit 三页：  
   - 今日龙虎概览  
   - 游资详情  
   - 个股详情  
3. 指标库：净买额、胜率、持仓成本估算  
4. 阈值告警：净买 > 3000 万即推送 

---

## 六、技术实现分工 (Code vs. LLM)

以下按照核心功能拆解中的顺序，说明每个功能点由代码（Code）与大模型（LLM）分别承担的职责。

### 0. 数据接入与质检
- **Code 实现 (100%)**
  1. 自动拉取四张 CSV → ETL → DB
  2. 字段命名与类型标准化、异常值/缺失值校验
  3. 生成质检报告（JSON/表格），写入日志表
- **LLM 赋能**
  - 可选：当质检发现异常时，将异常描述交给 LLM，总结成可读性更高的告警说明，用于推送。

### 1. 游资画像模块
1. **基础档案**
   - Code：读取 `trader_profile` 表输出结构化信息
   - LLM：根据 `desc` 字段 + 量化战绩生成风格标签与一段人性化简介
2. **资金规模估算**
   - Code：聚合 `trader_trade_daily` 过去 30/60/120 日买卖金额
   - LLM：对资金规模做风险提示/资金实力解读
3. **胜率 & 平均持股日**
   - Code：结合后续行情数据计算胜率、持股天数
   - LLM：用自然语言解释该游资稳健程度与操作节奏
4. **一键对比（雷达图）**
   - Code：生成多游资战绩指标矩阵 + 雷达图数据
   - LLM：生成对比点评，例如"赵老哥在收益率维度领先，但持股时长波动较大…"

### 2. 个股龙虎榜解析
1. **单股席位榜**
   - Code：查询 `top_stock_detail`，输出买/卖五席位金额及占比
   - LLM：解释买卖力量结构及潜在意图
2. **概览指标**
   - Code：计算净买额、换手贡献等数值
   - LLM：将指标翻译为普通投资者可理解的结论（机会/风险）
3. **历史对照**
   - Code：拉取近 N 日上榜记录与行情，生成曲线数据
   - LLM：判断本次上榜属于"延续性买入"还是"高位获利了结"等场景
4. **AI 点评（可选）**
   - LLM：汇总以上结构化数据，生成三段式点评（机会、风险、策略）

### 3. 游资-个股关系网络（Graph）
- **Code 实现**
  - 构建节点（游资/股票）与边（买卖金额权重）
  - 后端提供图查询 API
- **LLM 赋能**
  - 输入：某个子图或路径（如"最近 3 日同买一股的游资"）
  - 输出：用故事化语言解释背后的联动关系，提示潜在抱团信号

### 4. 主题/题材热度追踪
1. **题材映射 & 统计**
   - Code：完成股票 ↔ 题材映射，聚合计算净买额、上榜次数
2. **热度榜输出**
   - Code：生成榜单数据与柱状/热力图
   - LLM：分析题材阶段（导入/成长期/衰退）并给出操作建议

### 5. 高级指标 & 信号引擎（Pro）
- **指标计算**（锁仓强度、游资抱团度、跳槽信号） → Code
- **策略 DSL**：
  - Code：将勾选条件转译为 SQL / Python 查询
- **LLM 赋能**：
  - 根据命中结果，为用户生成策略解释与风险提示

### 6. 实时预警 & 推送
- **Code 实现**
  - 监听指标阈值，触发 Webhook / 消息队列
  - 推送原始数据包 + 预警类型
- **LLM 赋能**
  - 将原始数据包摘要为用户可读的通知文案，例如"⚠️ 3 大游资联合买入 XX 股 1.2 亿，抱团度 92%，历史胜率 68%。"

### 技术分层总结
1. **数据层 (Code)**：ETL、存储、指标计算
2. **业务层 (Code+LLM)**：策略规则、图分析、题材热度
3. **解释层 (LLM)**：自然语言分析、风险提示、推送文案
4. **交互层 (LLM)**：问答、个性化服务

这样分工可以在保证性能与准确性的同时，充分发挥大模型的语言理解与生成优势。 