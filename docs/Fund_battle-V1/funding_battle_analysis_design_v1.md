# 设计方案：龙虎榜资金博弈分析模块 (深化版)

## 1. 核心目标

将原始的十大买卖席位数据，提炼成一份结构化的**"资金博弈概要 (Funding Battle Summary)"**。这份概要将清晰地定义多空双方的**核心主力**、**助攻力量**、**力量对比**和**战局性质**，让大语言模型（LLM）可以基于这份高质量的输入，生成精准、深刻的分析。

我们要做的是在数据投喂给LLM之前，进行一次关键的"预处理"和"特征工程"，从"战场简报"升级到"参谋级战术分析报告"。

## 2. 核心数据结构设计 (深化版)

我们的目标是生成一个名为 `FundingBattleSummary` 的JSON对象，它将是后续所有分析（无论是LLM生成文本，还是前端可视化）的统一数据源。

```json
// 升级后的 FundingBattleSummary 结构
{
  "ts_code": "股票代码",
  "name": "股票名称",
  "basic_info": { 
    // ... 保留原始基础信息
  },
  "long_side": { 
    // ... 多方阵营分析
  },
  "short_side": { 
    // ... 空方阵营分析
  },
  "synergy_groups": [ // 识别出的协同小组
    {
      "group_name": "T王",
      "type": "知名游资",
      "side": "short", // 该小组属于哪一方
      "seats_involved": ["东方财富证券...第一...", "东方财富证券...第二..."],
      "total_buy_amount": "...",
      "total_sell_amount": "...",
      "net_amount": "..."
    }
  ],
  "battle_assessment": { 
    // ... 整体战局评估
  }
}
```

## 3. 阵营分析 (`long_side` / `short_side`) 详解

对席位进行**角色划分**和**实力评估**。

```json
"long_side": {
  "total_amount_on_list": "2.37亿元",    // 榜上总买入额
  "player_count": 5,                      // 榜上玩家数量
  "famous_player_count": 1,               // 知名游资数量
  "core_players": [                       // 核心主力 (筛选出的关键先生)
    {
      "seat_name": "中信证券股份有限公司浙江分公司",
      "buy_amount": "0.65亿元",
      "player_type": "普通席位",
      "role_tags": ["主导多头"],           // AI标注的角色 (数组)
      "reasons": ["买入金额第一"]         // 成为核心主力的原因 (数组)
    },
    {
      "seat_name": "国泰海通证券股份有限公司成都北一环路证券营业部",
      "buy_amount": "0.41亿元",
      "player_type": "知名游资",
      "role_tags": ["核心游资"],
      "reasons": ["知名游资", "买入金额第三"]
    }
  ],
  "other_players": [ 
    // ... 其他助攻或跟随的力量
  ],
  "summary": {
    "concentration": "44.7%",             // 核心主力的资金集中度
    "style_tags": ["打板", "短线交易"],   // 核心主力们的综合风格
    "conclusion": "由普通席位和知名游资'成都系'联手主导进攻。" // 一句话战术总结
  }
}
```

## 4. 关键指标与意图解读

### 4.1 净额（net_amount）——方向信号之母
- **净买入**：强烈做多信号，金额越大越能确认多头意图。
- **净卖出**：做空信号，金额越大空头越具决定性。
- **做T席位**：买卖额均大而净额很小（甚至为负）。代表日内高频交易，对趋势指向意义有限，但提示该股短线波动大、流动性好。

### 4.2 买卖力量对比（l_buy vs l_sell）
- 对比龙虎榜总买入额 `l_buy` 与总卖出额 `l_sell`。
- 若 `l_buy` » `l_sell` 且买方多为实力游资/机构，则认定为**多头主导**；反之为空头。
- **示例**（以【红太阳 000525.SZ】为例）：`net_amount` 1.28 亿元，`l_buy` 2.37 亿元明显大于 `l_sell` 1.09 亿元，多头优势显著。

### 4.3 玩家风格识别（player_info.style & description）
| 风格 | 行为特征 | 策略含义 |
| ---- | -------- | -------- |
| 打板 | 涨停板买入，追求隔日溢价 | 次日高开概率高，但波动大 |
| 砸盘 | 冲高抛售，追踪短线利润 | 次日冲高回落风险大 |
| 锁仓 | 买入后倾向持股 | 行情持续性更好 |
| 做T/量化 | 买卖双向活跃，净额小 | 提供流动性，波动加剧 |

> 以上风格将通过 `style_tags` 字段沉淀在 `core_players` 与 `other_players` 中，并在后续战局评估中叠加权重。

## 5. 协同小组（Synergy Groups）识别逻辑

1. **同门派聚合**：同一天上榜、归属相同"游资家族/量化模型"的多个席位自动聚为一组。  
2. **金额阈值过滤**：组内累计买入或卖出金额需 ≥ 当日成交额的 3%，方认定为"具备影响力"。  
3. **战局归属**：根据组内净额方向，标记 `side="long"` / `side="short"`，写入 `synergy_groups`。  
4. **组级指标**：输出买入、卖出、净额、风格交集等，供前端绘制"协同攻击/撤退"流向箭头。

## 6. 战局画像标签体系（battle_tags 扩充）

| 标签 | 触发条件 |
| ---- | -------- |
| 高位换手 | `l_buy`、`l_sell` 均 ≥ 当日成交额 8% 且股价处于近 30 日高位 |
| 游资主导局 | 多空双方核心玩家均为游资席位，机构影响力 < 30% |
| 机构出逃局 | 卖方核心席位包含公募、保险、QFII 等机构，净卖出占比 ≥ 60% |
| 多空胶着 | `l_buy` 与 `l_buy` 差不多  |
| 强力锁仓 | 多方净买入占比 ≥ 70% 且核心玩家风格包含"锁仓" |
| 一日游嫌疑 | 同一席位当日既在买榜又在卖榜，且买卖额占成交额 ≥ 5% |

这些标签将在 `battle_assessment.battle_tags` 字段中以数组形式返回，可同时命中多枚。

##  整体战局评估 (`battle_assessment`) (升级版)

```json
"battle_assessment": {
  "winner": "多方",
  "net_advantage": "1.28亿元",
  "long_strength_score": 85,
  "short_strength_score": 52,
  "battle_tags": ["游资主导局", "强力锁仓"], // 新增：战局画像标签
  "key_takeaway": "多方在资金总量和核心力量上均占优势，知名游资积极介入；空方虽有游资出逃，但力量相对分散，多方胜算较大。"
}
```

*   **战局标签 (`battle_tags`) 示例**：
    *   `游资主导局`: 核心玩家以知名游资为主。
    *   `机构出逃局`: 卖方核心是机构席位。
    *   `多空胶着`: 双方实力评分接近 (分差 < 10)。
    *   `强力锁仓`: 多方实力远超空方，且净额纯度高。
    *   `高位换手`: 买卖双方都有大量资金，股价处于高位。
    *   `一日游嫌疑`: 核心玩家在买卖榜单上同时出现。

---

## 7. 实施建议与总结

通过以上深化，我们建立了一个三层分析框架：
1.  **L1 - 原始数据层**: `test-seat.json`
2.  **L2 - 结构化情报层**: `FundingBattleSummary` 对象，通过精细化规则和量化模型，将数据转化为情报。
3.  **L3 - 自然语言分析层**: 将L2的情报喂给LLM，生成最终的复盘报告。

这个升级版的设计，极大地提高了喂给LLM的"饲料"质量，能确保最终产出的分析报告更加专业、深入，也更符合A股市场的实战逻辑。

## 实施步骤

1.  **创建数据处理模块**: 新建一个Python文件或函数，专门负责将 `test-seat.json` 中的数据转换为 `FundingBattleSummary` 结构。
2.  **实现规则引擎**: 在模块中编码实现"核心玩家"的识别逻辑。
3.  **构建输出**: 按照上述设计，组装最终的JSON对象。
4.  **注入LLM**: 将这个处理好的 `FundingBattleSummary` 对象序列化后，作为上下文（Context）提供给LLM，并提出明确的分析要求（例如："请根据这份战情简报，生成一份500字的龙虎榜复盘分析"）。

## 优势总结

*   **降维聚焦**: 将复杂的10v10表格，简化为有主次、有逻辑的结构化情报。
*   **逻辑前置**: 将"谁是主力"这类确定性高的判断交给代码完成，保证了分析的稳定性和一致性，减少LLM的"幻觉"。
*   **提升LLM分析质量**: 高质量的输入，才能引导LLM产出高质量的输出。这份简报能让LLM的分析直达要害。
*   **前后端通用**: 这个JSON结构不仅可以给LLM用，也可以直接作为API返回给前端，用于渲染您设想的"资金博弈图谱"可视化界面。 